# Pleroma 安装教程
## 安装基础环境
```bash
sudo apt update
sudo apt install curl wget gnupg apt-transport-https lsb-release ca-certificates unzip libncurses5 libmagic-dev imagemagick libimage-exiftool-perl
```
## 安装数据库
```
sudo wget -O /usr/share/keyrings/postgresql.asc https://www.postgresql.org/media/keys/ACCC4CF8.asc
echo "deb [signed-by=/usr/share/keyrings/postgresql.asc] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/postgresql.list
sudo apt update
sudo apt install postgresql-15 postgresql-contrib
```
## 安装ffmpeg
```
wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
tar xf ffmpeg-release-amd64-static.tar.xz
cd ffmpeg-5.1.1-amd64-static
sudo mv ffmpeg ffprobe /usr/local/bin/
sudo ln -s /usr/local/bin/ffmpeg /usr/bin/
```
## 创建Pleroma用户
```
sudo adduser --system --shell /bin/false --home /opt/pleroma pleroma
```
## 安装Pleroma
 - 安装主程序，如果使用官方正式版，一定要把配置文件置于`/etc/pleroma`下
```bash
cd /opt/pleroma
sudo -u pleroma curl 'https://git.pleroma.social/api/v4/projects/2/jobs/artifacts/stable/download?job=amd64' -o ./pleroma.zip
sudo -u pleroma unzip pleroma.zip -d 1
sudo -u pleroma mv 1/release/* /opt/pleroma
sudo -u pleroma rm -rf 1/ pleroma.zip
sudo mkdir -p /etc/pleroma
sudo chown -R pleroma. /etc/pleroma
```
 - 生成配置与数据库
```
sudo -u pleroma /opt/pleroma/bin/pleroma_ctl instance gen --output /etc/pleroma/config.exs --output-psql /tmp/setup_db.psql
```
```
!!! Config path is not declared! Please ensure it exists and that PLEROMA_CONFIG_PATH is unset or points to an existing file
What domain will your instance use? (e.g pleroma.soykaf.com) [] 您的网站将使用什么网址？
What is the name of your instance? (e.g. The Corndog Emporium) [] 您的网站叫什么名字？
What is your admin email address? [] 网站管理员的邮箱地址是什么？
What email address do you want to use for sending email notifications? [] 您想要用什么邮件地址来发送邮件通知？（这里先输入邮箱，之后若要向用户发送邮件需要额外配置）
Do you want search engines to index your site? (y/n) [y] 您希望搜索引擎收录您的网站吗？（建议不收录）
Do you want to store the configuration in the database (allows controlling it from admin-fe)? (y/n) [n] y 您希望将配置信息存入数据库吗（允许从管理后台进行控制）？（建议存入，否则 admin-fe 将无法使用）
What is the hostname of your database? [localhost] Postgresql数据库的连接地址
What is the name of your database? [] 数据库名称
What is the user used to connect to your database? [] 创建数据库的用户名
What is the password used to connect to your database? [autogenerated] 创建数据库的用户密码（没有则自动创建）
Would you like to use RUM indices? [n] 是否要使用 RUM 索引？（机器性能好的话建议使用）
What port will the app listen to (leave it if you are using the default setup with nginx)? [4000] 连接端口
What ip will the app listen to (leave it if you are using the default setup with nginx)? [127.0.0.1] 连接地址
What directory should media uploads go in (when using the local uploader)? [/var/lib/pleroma/uploads] /opt/pleroma/uploads 媒体文件上传地址
What directory should custom public files be read from (custom emojis, frontend bundle overrides, robots.txt, etc.)? [/var/lib/pleroma/static] /opt/pleroma/static 静态页面地址
Do you want to strip location (GPS) data from uploaded images? This requires exiftool, it was detected as installed. (y/n) [y] y 您希望从上传的图片中消除 GPS 信息吗？（建议消除）
Do you want to anonymize the filenames of uploads? (y/n) [n] y 您希望将上传文件的文件名匿名化吗？（建议匿名化）
Do you want to deduplicate uploaded files? (y/n) [n] y 您希望去除重复的已上传文件吗？（建议去除）
Writing config to /etc/pleroma/config.exs.
Writing the postgres script to /tmp/setup_db.psql.
Writing /opt/pleroma/static/robots.txt.

# 如果成功则有如下显示：

All files successfully written! Refer to the installation instructions for your platform for next steps.
Please transfer your config to the database after running database migrations. Refer to “Transfering the config to/from the database” section of the docs for more information.
```
 - 创建数据库
```
sudo -u postgres psql -f /tmp/setup_db.psql
sudo -u pleroma /opt/pleroma/bin/pleroma_ctl migrate
```

## 开机启动
```
sudo nano /etc/systemd/system/pleroma.service
```
- 启动脚本
```
[Unit]
Description=Pleroma social network
After=network.target postgresql.service caddy.service

[Service]
KillMode=process
Restart=on-failure
User=pleroma
Environment="HOME=/opt/pleroma"
WorkingDirectory=/opt/pleroma
ExecStart=/opt/pleroma/bin/pleroma start
ExecStop=/opt/pleroma/bin/pleroma stop
PrivateTmp=true
ProtectHome=true
ProtectSystem=full
PrivateDevices=false
NoNewPrivileges=true
CapabilityBoundingSet=~CAP_SYS_ADMIN

[Install]
WantedBy=multi-user.target
```
- 激活开机启动
```
sudo systemctl daemon-reload
sudo systemctl enable --now pleroma
```

## 设置Caddyfile, Caddy自行安装，换掉配置里的`xx.yy`为自己的域名
```
{
  order reverse_proxy before map
  admin off
  log {
    output discard
  }
  servers :443 {
    protocols h1 h2
  }
  default_sni xx.yy
}
xx.yy {
  encode {
    gzip 6
  }
  tls {
    protocols tls1.3
    curves x25519
    alpn h2
  }

  @pleroma {
    host xx.yy
  }
  route @pleroma {
    header {
      Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
      X-Content-Type-Options nosniff
      X-Frame-Options SAMEORIGIN
      Referrer-Policy no-referrer-when-downgrade
    }
    reverse_proxy 127.0.0.1:4000 {
      header_up Host {host}
      header_up X-Real-IP {remote}
    }
  }
}
```

## 创建第一个用户，管理账户，用户名只能用英文加字母，不能用特殊符号，邮件地址换为自己常用邮件地址.
```
sudo -u pleroma /opt/pleroma/bin/pleroma_ctl user new 用户名 邮件@地址 --admin
```
* 填写正确后按`Y`, 跑完后会给你一个地址，访问此地址给你的用户名加上密码，这是必须的。

## 前端(话外)
* 这个前端挺漂亮，如果你只喜欢用app，这个前端可不安装
```
cd ~
curl -L https://gitlab.com/soapbox-pub/soapbox/-/jobs/artifacts/develop/download?job=build-production -o soapbox.zip
sudo -u pleroma unzip soapbox.zip -d /opt/pleroma/
```
