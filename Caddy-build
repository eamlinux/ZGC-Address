wget -c https://dl.google.com/go/go1.13.8.linux-amd64.tar.gz
tar xf go1.13.8.linux-amd64.tar.gz
sudo mv go /usr/local/
sudo ln -snf /usr/local/go/bin/* /usr/local/bin/
sudo setcap CAP_NET_BIND_SERVICE=+eip /usr/local/bin/caddy
sudo apt install binutils -y
sudo apt install git -y
git clone https://github.com/caddyserver/caddy.git
nano caddy/caddy/caddymain/run.go

_ "github.com/caddyserver/forwardproxy"

cd caddy/caddy
go build .
strip -s caddy
sudo mv caddy /usr/local/bin/
sudo chown root:root /usr/local/bin/caddy
sudo chmod 0755 /usr/local/bin/caddy

sudo nano /etc/systemd/system/caddy.service

[Unit]
Description=Caddy HTTP/2 web server
Documentation=https://caddyserver.com/docs
After=network-online.target
Wants=network-online.target systemd-networkd-wait-online.service
StartLimitIntervalSec=14400
StartLimitBurst=10

[Service]
Restart=on-abnormal
User=www-data
Group=www-data
Environment=CADDYPATH=/etc/ssl/caddy
EnvironmentFile=-/etc/caddy/envfile
ExecStart=/usr/local/bin/caddy -log stdout -log-timestamps=false -agree=true -conf=/opt/caddy/Caddyfile -root=/var/tmp
ExecReload=/bin/kill -USR1 $MAINPID

KillMode=mixed
KillSignal=SIGQUIT
TimeoutStopSec=5s

LimitNOFILE=1048576
LimitNPROC=512

PrivateTmp=true
PrivateDevices=true
ProtectHome=true
ProtectSystem=strict
ReadWritePaths=/etc/ssl/caddy
#ReadWriteDirectories=/etc/ssl/caddy
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
NoNewPrivileges=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
LockPersonality=true

[Install]
WantedBy=multi-user.target


sudo nano /opt/caddy/Caddyfile

xxx.com {
  root /var/www/html/mikutap
  tls xxx@xxx.com {
  protocols tls1.3
  alpn h2
  }
  proxy /off localhost:9443 {
    #header_upstream Host {host}
    #header_upstream X-Real-IP {remote}
    #header_upstream X-Forwarded-For {remote}
    #header_upstream X-Forwarded-Port {server_port}
    #header_upstream X-Forwarded-Proto {scheme}
    websocket
    header_upstream -Origin
  }
}




forwardproxy {
basicauth user password
hide_ip
hide_via
}


#简化

[Unit]
Description=Caddy HTTP/2 web server
Documentation=https://caddyserver.com/docs
After=network-online.target
Wants=network-online.target systemd-networkd-wait-online.service

[Service]
Restart=on-abnormal
User=www-data
Group=www-data
Environment=CADDYPATH=/etc/ssl/caddy
EnvironmentFile=-/etc/caddy/envfile
ExecStart=/usr/local/bin/caddy -log stdout -log-timestamps=false -agree=true -conf=/opt/caddy/Caddyfile -root=/var/tmp
ExecReload=/bin/kill -USR1 $MAINPID
KillMode=mixed
KillSignal=SIGQUIT
TimeoutStopSec=5s
LimitNOFILE=1048576
LimitNPROC=512

[Install]
WantedBy=multi-user.target
